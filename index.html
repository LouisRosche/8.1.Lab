<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collision Forces Lab - OpenSciEd Unit 8.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #60a5fa;
            --secondary: #34d399;
            --accent: #fbbf24;
            --danger: #f87171;
            --dark: #0f172a;
            --dark-panel: #1e293b;
            --dark-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #4ade80;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .app-header {
            background: var(--dark-panel);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .learning-goals {
            background: var(--dark-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin: 1rem auto;
            max-width: 1600px;
        }

        .goal-badge {
            display: inline-block;
            background: var(--dark-input);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.85rem;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 1rem;
        }

        .panel {
            background: var(--dark-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .control-value {
            font-weight: 700;
            color: var(--primary);
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--dark-input);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preset-btn {
            padding: 0.75rem;
            background: var(--dark-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .preset-btn:hover {
            border-color: var(--primary);
        }

        .preset-btn.active {
            background: var(--primary);
            color: var(--dark);
        }

        .material-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .material-btn {
            padding: 0.5rem;
            background: var(--dark-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .material-btn.selected {
            background: var(--secondary);
            color: var(--dark);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 450px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        canvas {
            display: block;
        }

        .measurement-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(15,23,42,0.95);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
        }

        .btn {
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--dark);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--dark);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .data-card {
            background: var(--dark-input);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            margin-bottom: 0.5rem;
        }

        .data-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .data-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .trials-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .trials-header {
            display: grid;
            grid-template-columns: 40px 1fr 70px 70px 50px;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--dark-input);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            position: sticky;
            top: 0;
        }

        .trial-row {
            display: grid;
            grid-template-columns: 40px 1fr 70px 70px 50px;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .trial-row.best {
            background: rgba(52,211,153,0.1);
        }

        .formula-box {
            background: var(--dark-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            text-align: center;
        }

        .formula {
            color: var(--primary);
            margin: 0.25rem 0;
        }

        .chart-container {
            height: 200px;
            background: var(--dark-input);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-content">
            <h1 class="app-title">‚ö° Collision Forces Laboratory</h1>
            <div>OpenSciEd Unit 8.1</div>
        </div>
    </div>

    <div class="learning-goals">
        <strong>Learning Objectives:</strong>
        <span class="goal-badge">F = ma</span>
        <span class="goal-badge">KE = ¬Ωmv¬≤</span>
        <span class="goal-badge">Energy Transfer</span>
        <span class="goal-badge">Material Properties</span>
        <span class="goal-badge">Engineering Design</span>
    </div>

    <div class="main-container">
        <!-- Controls -->
        <div class="panel">
            <div class="panel-title">‚öôÔ∏è Controls</div>
            
            <div class="control-group">
                <div class="preset-grid">
                    <button class="preset-btn" onclick="loadPreset('drop')">üì± Drop Test</button>
                    <button class="preset-btn" onclick="loadPreset('mass')">‚öñÔ∏è Mass Study</button>
                    <button class="preset-btn" onclick="loadPreset('height')">üìè Height Test</button>
                    <button class="preset-btn" onclick="loadPreset('materials')">üß™ Materials</button>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Mass</span>
                    <span class="control-value" id="massValue">150 g</span>
                </div>
                <input type="range" class="slider" id="mass" min="50" max="500" value="150" step="10" oninput="updateValue('mass')">
                
                <div class="control-label">
                    <span>Drop Height</span>
                    <span class="control-value" id="heightValue">1.5 m</span>
                </div>
                <input type="range" class="slider" id="height" min="0.5" max="3" value="1.5" step="0.1" oninput="updateValue('height')">
            </div>

            <div class="control-group">
                <strong style="margin-bottom: 0.5rem; display: block;">Cushioning</strong>
                <div class="material-selector">
                    <button class="material-btn selected" onclick="selectMaterial('none')">None</button>
                    <button class="material-btn" onclick="selectMaterial('foam')">Foam</button>
                    <button class="material-btn" onclick="selectMaterial('gel')">Gel</button>
                    <button class="material-btn" onclick="selectMaterial('air')">Air</button>
                    <button class="material-btn" onclick="selectMaterial('rubber')">Rubber</button>
                    <button class="material-btn" onclick="selectMaterial('spring')">Spring</button>
                </div>
                
                <div class="control-label" style="margin-top: 1rem;">
                    <span>Thickness</span>
                    <span class="control-value" id="thicknessValue">10 mm</span>
                </div>
                <input type="range" class="slider" id="thickness" min="5" max="30" value="10" oninput="updateValue('thickness')">
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="runSimulation()">‚ñ∂ RUN</button>
                <button class="btn btn-danger" onclick="resetAll()">RESET</button>
            </div>
        </div>

        <!-- Simulation -->
        <div class="panel">
            <div class="panel-title">üî¨ Simulation</div>
            
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
                <div class="measurement-overlay">
                    <strong>Live Data</strong><br>
                    Height: <span id="liveHeight">1.50</span> m<br>
                    Velocity: <span id="liveVel">0.00</span> m/s<br>
                    Force: <span id="liveForce">0.0</span> N<br>
                    Time: <span id="liveTime">0.00</span> s
                </div>
            </div>

            <div class="formula-box">
                <div class="formula">v = ‚àö(2gh) = ‚àö(2 √ó 9.81 √ó <span id="fHeight">1.5</span>) = <span id="fVel">5.42</span> m/s</div>
                <div class="formula">KE = ¬Ω √ó <span id="fMass">0.15</span> kg √ó <span id="fVel2">5.42</span>¬≤ = <span id="fKE">2.20</span> J</div>
            </div>

            <div class="chart-container">
                <canvas id="chartCanvas"></canvas>
            </div>
        </div>

        <!-- Results -->
        <div class="panel">
            <div class="panel-title">üìä Results</div>
            
            <div class="data-card">
                <div class="data-label">Peak Force</div>
                <div class="data-value" id="peakForce">---</div>
            </div>
            <div class="data-card">
                <div class="data-label">Impact Time</div>
                <div class="data-value" id="impactTime">---</div>
            </div>
            <div class="data-card">
                <div class="data-label">Max Speed</div>
                <div class="data-value" id="maxSpeed">---</div>
            </div>
            <div class="data-card">
                <div class="data-label">Energy Loss</div>
                <div class="data-value" id="energyLost">---</div>
            </div>

            <strong style="margin: 1rem 0 0.5rem; display: block;">Trial History</strong>
            <div class="trials-container">
                <div class="trials-header">
                    <div>#</div>
                    <div>Setup</div>
                    <div>Force</div>
                    <div>Energy</div>
                    <div>Del</div>
                </div>
                <div id="trialsBody"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
                <button class="btn btn-secondary" onclick="exportJSON()">Export JSON</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            isRunning: false,
            material: 'none',
            trials: [],
            trialNum: 0,
            animId: null,
            simData: {
                y: 0,
                vy: 0,
                maxForce: 0,
                maxVel: 0,
                impactStart: null,
                impactEnd: null
            }
        };

        // Canvas setup
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const chartCanvas = document.getElementById('chartCanvas');
        const chartCtx = chartCanvas.getContext('2d');

        function initCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            chartCanvas.width = rect.width - 32;
            chartCanvas.height = 168;
            drawStaticScene();
        }

        window.addEventListener('load', initCanvas);
        window.addEventListener('resize', initCanvas);

        // Update slider values
        function updateValue(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');
            
            const formats = {
                mass: v => v + ' g',
                height: v => v + ' m',
                thickness: v => v + ' mm'
            };
            
            display.textContent = formats[id](slider.value);
            updateFormulas();
        }

        function updateFormulas() {
            const mass = document.getElementById('mass').value / 1000;
            const height = document.getElementById('height').value;
            const vel = Math.sqrt(2 * 9.81 * height);
            const ke = 0.5 * mass * vel * vel;
            
            document.getElementById('fHeight').textContent = height;
            document.getElementById('fMass').textContent = mass.toFixed(2);
            document.getElementById('fVel').textContent = vel.toFixed(2);
            document.getElementById('fVel2').textContent = vel.toFixed(2);
            document.getElementById('fKE').textContent = ke.toFixed(2);
        }

        // Material selection
        function selectMaterial(mat) {
            state.material = mat;
            document.querySelectorAll('.material-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Auto-adjust thickness
            const thickness = {none: 0, foam: 15, gel: 10, air: 20, rubber: 8, spring: 12};
            document.getElementById('thickness').value = thickness[mat] || 10;
            updateValue('thickness');
        }

        // Presets
        function loadPreset(type) {
            const presets = {
                drop: {mass: 150, height: 1.5, material: 'none'},
                mass: {mass: 300, height: 1, material: 'foam'},
                height: {mass: 150, height: 2.5, material: 'foam'},
                materials: {mass: 150, height: 1.5, material: 'gel'}
            };
            
            const p = presets[type];
            if (p) {
                document.getElementById('mass').value = p.mass;
                document.getElementById('height').value = p.height;
                updateValue('mass');
                updateValue('height');
                
                // Select material button
                state.material = p.material;
                document.querySelectorAll('.material-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent.toLowerCase().includes(p.material)) {
                        btn.classList.add('selected');
                    }
                });
            }
        }

        // Draw static scene
        function drawStaticScene() {
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ground
            ctx.fillStyle = '#334155';
            ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
            
            // Grid lines
            ctx.strokeStyle = 'rgba(148,163,184,0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.height; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // Height markers
            ctx.fillStyle = '#64748b';
            ctx.font = '11px sans-serif';
            for (let h = 0; h <= 3; h += 0.5) {
                const y = canvas.height - 80 - h * 100;
                if (y > 0) {
                    ctx.fillText(h + 'm', 5, y);
                }
            }
        }

        // Run simulation
        function runSimulation() {
            if (state.isRunning) return;
            state.isRunning = true;
            
            // Reset sim data
            state.simData = {
                y: 50,
                vy: 0,
                maxForce: 0,
                maxVel: 0,
                impactStart: null,
                impactEnd: null,
                forceHistory: [],
                time: 0
            };
            
            // Get parameters
            const mass = document.getElementById('mass').value / 1000;
            const height = document.getElementById('height').value;
            const thickness = document.getElementById('thickness').value / 1000;
            
            // Material properties
            const materials = {
                none: {k: 100000, c: 0.9},
                foam: {k: 5000, c: 0.3},
                gel: {k: 8000, c: 0.2},
                air: {k: 3000, c: 0.25},
                rubber: {k: 15000, c: 0.5},
                spring: {k: 10000, c: 0.35}
            };
            
            const mat = materials[state.material];
            const groundY = canvas.height - 80;
            const dropHeight = height * 100; // pixels
            
            // Animation loop
            function animate() {
                if (!state.isRunning) return;
                
                // Clear and redraw
                drawStaticScene();
                
                // Physics (simplified for visualization)
                state.simData.vy += 9.81 * 0.016 * 100; // gravity scaled to pixels
                state.simData.y += state.simData.vy * 0.016;
                
                const vel = Math.abs(state.simData.vy) / 100; // m/s
                state.simData.maxVel = Math.max(state.simData.maxVel, vel);
                
                // Draw cushion
                if (state.material !== 'none') {
                    const colors = {foam: '#fbbf24', gel: '#60a5fa', air: '#e0f7fa', 
                                   rubber: '#c084fc', spring: '#34d399'};
                    ctx.fillStyle = colors[state.material] || '#94a3b8';
                    ctx.fillRect(0, groundY - thickness * 3000, canvas.width, thickness * 3000);
                }
                
                // Draw phone
                const phoneX = canvas.width / 2;
                ctx.fillStyle = '#334155';
                ctx.fillRect(phoneX - 20, state.simData.y, 40, 60);
                ctx.fillStyle = '#60a5fa';
                ctx.fillRect(phoneX - 18, state.simData.y + 5, 36, 45);
                
                // Collision detection
                const objectBottom = state.simData.y + 60;
                const collisionY = state.material === 'none' ? groundY : groundY - thickness * 3000;
                
                if (objectBottom >= collisionY) {
                    if (!state.simData.impactStart) {
                        state.simData.impactStart = state.simData.time;
                    }
                    
                    // Calculate force
                    const penetration = Math.max(0, objectBottom - collisionY) / 100;
                    const force = mat.k * penetration + mat.c * vel * 10;
                    state.simData.maxForce = Math.max(state.simData.maxForce, force);
                    state.simData.forceHistory.push(force);
                    
                    // Bounce
                    state.simData.vy = -Math.abs(state.simData.vy) * (1 - mat.c);
                    state.simData.y = collisionY - 60;
                    
                    // Stop condition
                    if (Math.abs(state.simData.vy) < 50) {
                        state.simData.impactEnd = state.simData.time;
                        finishSimulation(mass, height, thickness);
                        return;
                    }
                }
                
                // Update displays
                const currentHeight = Math.max(0, (groundY - objectBottom) / 100);
                document.getElementById('liveHeight').textContent = currentHeight.toFixed(2);
                document.getElementById('liveVel').textContent = vel.toFixed(2);
                document.getElementById('liveForce').textContent = state.simData.maxForce.toFixed(1);
                document.getElementById('liveTime').textContent = state.simData.time.toFixed(2);
                
                state.simData.time += 0.016;
                state.animId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Finish simulation
        function finishSimulation(mass, height, thickness) {
            state.isRunning = false;
            
            const maxVel = state.simData.maxVel;
            const maxForce = state.simData.maxForce;
            const impactTime = (state.simData.impactEnd - state.simData.impactStart) * 1000;
            const ke = 0.5 * mass * maxVel * maxVel;
            const pe = mass * 9.81 * height;
            const energyLoss = ((pe - ke) / pe * 100) || 0;
            
            // Update displays
            document.getElementById('peakForce').textContent = maxForce.toFixed(1) + ' N';
            document.getElementById('impactTime').textContent = impactTime.toFixed(1) + ' ms';
            document.getElementById('maxSpeed').textContent = maxVel.toFixed(2) + ' m/s';
            document.getElementById('energyLost').textContent = Math.abs(energyLoss).toFixed(1) + '%';
            
            // Save trial
            state.trialNum++;
            state.trials.push({
                num: state.trialNum,
                mass: mass * 1000,
                height: height,
                material: state.material,
                thickness: thickness * 1000,
                force: maxForce,
                energy: energyLoss,
                forceHistory: state.simData.forceHistory
            });
            
            updateTrials();
            drawChart();
        }

        // Update trials display
        function updateTrials() {
            const tbody = document.getElementById('trialsBody');
            tbody.innerHTML = '';
            
            // Find best
            let minForce = Infinity;
            let bestTrial = null;
            state.trials.forEach(t => {
                if (t.force < minForce) {
                    minForce = t.force;
                    bestTrial = t;
                }
            });
            
            // Show last 10 trials
            state.trials.slice(-10).reverse().forEach(trial => {
                const row = document.createElement('div');
                row.className = 'trial-row';
                if (trial === bestTrial) row.className += ' best';
                
                row.innerHTML = `
                    <div>#${trial.num}</div>
                    <div>${trial.material} ${trial.thickness.toFixed(0)}mm</div>
                    <div>${trial.force.toFixed(1)}N</div>
                    <div>${trial.energy.toFixed(1)}%</div>
                    <div><button onclick="deleteTrial(${trial.num})" style="background: var(--danger); color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">√ó</button></div>
                `;
                tbody.appendChild(row);
            });
        }

        // Draw chart
        function drawChart() {
            chartCtx.fillStyle = '#334155';
            chartCtx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);
            
            if (state.trials.length === 0) return;
            
            // Get last 5 trials
            const trials = state.trials.slice(-5);
            const maxForce = Math.max(...trials.map(t => t.force));
            
            // Draw bars
            const barWidth = chartCanvas.width / trials.length * 0.8;
            const gap = chartCanvas.width / trials.length * 0.2;
            
            trials.forEach((trial, i) => {
                const barHeight = (trial.force / maxForce) * (chartCanvas.height - 30);
                const x = i * (barWidth + gap) + gap/2;
                const y = chartCanvas.height - barHeight - 20;
                
                // Bar
                chartCtx.fillStyle = trial === state.trials[state.trials.length-1] ? '#60a5fa' : '#64748b';
                chartCtx.fillRect(x, y, barWidth, barHeight);
                
                // Label
                chartCtx.fillStyle = '#94a3b8';
                chartCtx.font = '10px sans-serif';
                chartCtx.textAlign = 'center';
                chartCtx.fillText(trial.material, x + barWidth/2, chartCanvas.height - 5);
                
                // Value
                chartCtx.fillStyle = '#f1f5f9';
                chartCtx.fillText(trial.force.toFixed(0) + 'N', x + barWidth/2, y - 5);
            });
        }

        // Delete trial
        function deleteTrial(num) {
            state.trials = state.trials.filter(t => t.num !== num);
            updateTrials();
            drawChart();
        }

        // Reset
        function resetAll() {
            if (state.animId) cancelAnimationFrame(state.animId);
            state.isRunning = false;
            state.trials = [];
            state.trialNum = 0;
            
            document.getElementById('peakForce').textContent = '---';
            document.getElementById('impactTime').textContent = '---';
            document.getElementById('maxSpeed').textContent = '---';
            document.getElementById('energyLost').textContent = '---';
            document.getElementById('trialsBody').innerHTML = '';
            
            drawStaticScene();
            chartCtx.fillStyle = '#334155';
            chartCtx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);
        }

        // Export functions
        function exportCSV() {
            if (state.trials.length === 0) {
                alert('No data to export!');
                return;
            }
            
            let csv = 'Trial,Mass(g),Height(m),Material,Thickness(mm),Force(N),EnergyLoss(%)\n';
            state.trials.forEach(t => {
                csv += `${t.num},${t.mass},${t.height},${t.material},${t.thickness},${t.force.toFixed(1)},${t.energy.toFixed(1)}\n`;
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'collision_data.csv';
            a.click();
        }

        function exportJSON() {
            if (state.trials.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const blob = new Blob([JSON.stringify(state.trials, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'collision_data.json';
            a.click();
        }

        // Initialize
        updateFormulas();
    </script>
</body>
</html>
